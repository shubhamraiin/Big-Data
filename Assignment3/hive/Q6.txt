DROP TABLE IF EXISTS MOVIES;

CREATE TABLE MOVIES (MOVIEID STRING, TITLE STRING, GENRES STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY ':' LINES TERMINATED BY '\n';

LOAD DATA local INPATH '/usr/lib/hue/inputHw3/movies.dat' INTO TABLE MOVIES;

DROP TABLE IF EXISTS RATINGS;

CREATE TABLE RATINGS (USERID STRING,MOVIEID STRING, RATING INT, TIMESTAMP STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY ':' LINES TERMINATED BY '\n';

LOAD DATA local INPATH '/usr/lib/hue/inputHw3/ratings.dat' INTO TABLE RATINGS;

DROP TABLE IF EXISTS USERS;

CREATE TABLE USERS (USERID STRING,GENDER STRING,AGE INT,OCCUPATION STRING,ZIPCODE STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY ':' LINES TERMINATED BY '\n';

LOAD DATA local INPATH '/usr/lib/hue/inputHw3/users.dat' INTO TABLE USERS;

SELECT MOVIES.TITLE, MOVIES.GENRES
FROM USERS JOIN RATINGS ON USERS.USERID = RATINGS.USERID
JOIN MOVIES ON MOVIES.MOVIEID = RATINGS.MOVIEID
WHERE USERS.GENDER = "M" AND (INSTR(MOVIES.GENRES,"Comedy")>0 OR INSTR(MOVIES.GENRES,"Drama")>0)
GROUP BY MOVIES.MOVIEID,MOVIES.TITLE,MOVIES.GENRES
HAVING  AVG(RATING)  >= 4.5 AND  AVG(RATING)  <= 4.6;